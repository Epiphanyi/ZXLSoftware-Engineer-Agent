const input=document.getElementById("input");const send=document.getElementById("send");const regen=document.getElementById("regen");const messages=document.getElementById("messages");const refresh=document.getElementById("refresh");const addPath=document.getElementById("addPath");const addBtn=document.getElementById("addBtn");const curPath=document.getElementById("curPath");const rootBtn=document.getElementById("rootBtn");const upBtn=document.getElementById("upBtn");const fileList=document.getElementById("fileList");const previewBox=document.getElementById("previewBox");const datasetSel=document.getElementById("datasetSel");const loadExample=document.getElementById("loadExample");const modelInfo=document.getElementById("modelInfo");const flagReflect=document.getElementById("flagReflect");const flagTools=document.getElementById("flagTools");const flagTests=document.getElementById("flagTests");const suggest=document.getElementById("suggest");const newSession=document.getElementById("newSession");const sessionList=document.getElementById("sessionList");const toggleBrowser=document.getElementById("toggleBrowser");const toggleConfig=document.getElementById("toggleConfig");
function md(t){try{if(typeof marked!=="undefined"&&marked&&typeof marked.parse==="function"){return marked.parse(t||"")}}catch(_){}return t||""}
function roleMeta(cls){return cls==="user"?{label:"U",bubble:"user"}:cls==="assistant"?{label:"A",bubble:"assistant"}:{label:"T",bubble:"assistant"}}
function addMsg(text,cls){const row=document.createElement("div");row.className=`msgrow ${cls}`;const av=document.createElement("div");const meta=roleMeta(cls);av.className="avatar";av.textContent=meta.label;const bubble=document.createElement("div");bubble.className=`bubble ${meta.bubble}`;if(cls==="tool"){bubble.classList.add("tool")}const html=md(text||"");const safe=typeof DOMPurify!=="undefined"?DOMPurify.sanitize(html,{ADD_ATTR:['target']}):html;bubble.innerHTML=safe;row.appendChild(av);row.appendChild(bubble);messages.appendChild(row);messages.scrollTop=messages.scrollHeight;row.querySelectorAll("pre code").forEach(el=>{try{hljs.highlightElement(el)}catch(_){} })}
async function loadHistory(){const r=await fetch("/api/history");const j=await r.json();messages.innerHTML="";(j.messages||[]).forEach(m=>{const role=m.role==="user"?"user":m.role==="assistant"?"assistant":"tool";addMsg(m.content,role)})}
async function postText(t){addMsg(t,"user");send.disabled=true;try{const flags={reflect:!!(flagReflect&&flagReflect.checked),tools:!!(flagTools&&flagTools.checked),tests:!!(flagTests&&flagTests.checked)};const r=await fetch("/api/send",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:t,flags})});const j=await r.json();if(!r.ok||j.error){addMsg(`é”™è¯¯: ${j.error||"unknown"}`,"assistant");return}
    if(!j.assistant_text && (!j.tools_executed || j.tools_executed.length === 0)){
        addMsg("(No response from AI - check logs)", "assistant");
    }
    if(j.assistant_text){addMsg(j.assistant_text,"assistant")}if(Array.isArray(j.tools_executed)){for(const item of j.tools_executed){const name=item.name;const res=item.result;const ok=res&&res.success;let extra="";if(res&&res.message){extra=": "+res.message}else if(name==="run_command"){const err=(res&&res.stderr)||"";const code=(res&&typeof res.returncode!=="undefined")?` (code ${res.returncode})`:"";extra=err?": "+err.slice(0,400)+code:code}addMsg(`${name} æ‰§è¡Œ${ok?"æˆåŠŸ":"å¤±è´¥"}${extra}`,"tool")}}}catch(e){addMsg(`å¼‚å¸¸: ${e}`,"assistant")}finally{send.disabled=false}}
async function addContext(p){const r=await fetch("/api/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({path:p})});const j=await r.json();if(!r.ok){addMsg(`ä¸Šä¸‹æ–‡æ·»åŠ å¤±è´¥: ${j.error||"unknown"}`,"assistant")}else{addMsg(`å·²åŠ å…¥ä¸Šä¸‹æ–‡: ${p}`,"assistant")}}
async function listPath(p){curPath.textContent=p;const r=await fetch(`/api/list?path=${encodeURIComponent(p)}`);const j=await r.json();fileList.innerHTML="";if(j.success===false){fileList.textContent=j.error||"æ— æ³•åˆ—å‡ºç›®å½•";return}const items=j.items||[];items.forEach(it=>{const d=document.createElement("div");d.className="file";d.textContent=`${it.type==="directory"?"ğŸ“":"ğŸ“„"} ${it.name}`;d.addEventListener("click",()=>{const next=p.endsWith("/")?p+it.name:p+"/"+it.name;if(it.type==="directory"){listPath(next)}else{readFile(next)}});const add=document.createElement("button");add.textContent="åŠ å…¥ä¸Šä¸‹æ–‡";add.style.marginLeft="8px";add.addEventListener("click",ev=>{ev.stopPropagation();addContext(p.endsWith("/")?p+it.name:p+"/"+it.name)});d.appendChild(add);fileList.appendChild(d)})}
async function readFile(p){const r=await fetch(`/api/read?path=${encodeURIComponent(p)}`);const j=await r.json();if(j.success===false){previewBox.textContent=j.error||"è¯»å–å¤±è´¥";return}previewBox.textContent=j.content||""}
input.addEventListener("keydown",e=>{if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();if(!send.disabled){const t=input.value.trim();if(!t)return;input.value="";postText(t)}}});
refresh.addEventListener("click",loadHistory);
addBtn.addEventListener("click",()=>{const p=addPath.value.trim();if(!p)return;addContext(p)});
rootBtn.addEventListener("click",()=>listPath("."));
upBtn.addEventListener("click",()=>{const p=curPath.textContent;const parts=p.split("/");if(parts.length>1){parts.pop();listPath(parts.join("/")||".")}else{listPath(".")}})
loadHistory();listPath(".")
async function loadStatus(){try{const r=await fetch("/api/status");const j=await r.json();modelInfo.textContent=`Provider: ${j.provider||"-"} | Model: ${j.model||"-"}`}catch(e){modelInfo.textContent="çŠ¶æ€åŠ è½½å¤±è´¥"}}
loadStatus()
if(loadExample&&datasetSel){loadExample.addEventListener("click",()=>{const v=datasetSel.value;if(v==="HumanEval"){input.value="åŸºäº HumanEval çš„é¢˜ç›®ï¼šè¯·å®ç°å‡½æ•°ï¼Œä»¥é€šè¿‡å•å…ƒæµ‹è¯•ï¼›ç”Ÿæˆæµ‹è¯•å¹¶è¿è¡Œï¼Œå¤±è´¥ååæ€å¹¶ä¿®å¤"}else if(v==="MBPP"){input.value="åŸºäº MBPP çš„ç»ƒä¹ ï¼šå®ç°æŒ‡å®šå‡½æ•°ï¼Œç”Ÿæˆå¯¹åº”çš„æ ·ä¾‹ä¸æµ‹è¯•ï¼Œå¹¶é€šè¿‡æµ‹è¯•"}else{input.value="åŸºäº SWE-Bench çš„ä»»åŠ¡ï¼šå®šä½å¹¶ä¿®å¤æŒ‡å®šä»“åº“ä¸­çš„ç¼ºé™·ï¼Œç”Ÿæˆè¡¥ä¸ä¸æµ‹è¯•å¹¶éªŒè¯"}})}
let lastUser="";
send.addEventListener("click",()=>{if(send.disabled)return;const t=input.value.trim();if(!t)return;lastUser=t;input.value="";postText(t)});
regen.addEventListener("click",()=>{if(!lastUser)return;postText(lastUser)});
suggest.innerHTML="";
["ç”Ÿæˆè´ªåƒè›‡æ¸¸æˆ","åˆ†æ test_example.py å¹¶ç”Ÿæˆå•æµ‹","åˆ›å»º Flask API å¹¶å†™ README"].forEach(s=>{const c=document.createElement("div");c.className="chip";c.textContent=s;c.addEventListener("click",()=>{input.value=s});suggest.appendChild(c)})

// ä¼šè¯ç®¡ç†
async function loadSessions(){const r=await fetch("/api/session/list");const j=await r.json();sessionList.innerHTML="";const cur=j.current;const items=j.items||[];items.forEach(it=>{const d=document.createElement("div");d.className="item";d.textContent=`${it.id} ï¼ˆ${it.count}æ¡ï¼‰`;if(it.id===cur){d.classList.add("active")}d.addEventListener("click",()=>selectSession(it.id));sessionList.appendChild(d)});}
async function selectSession(id){try{const r=await fetch("/api/session/select",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id})});const j=await r.json();if(!r.ok){return}await loadSessions();await loadHistory()}catch(_){/* ignore */}}
if(newSession){newSession.addEventListener("click",async()=>{try{const r=await fetch("/api/session/new",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:""})});await r.json();await loadSessions();await loadHistory()}catch(_){}})}
loadSessions();

// æŠ˜å /å±•å¼€
if(toggleBrowser){toggleBrowser.addEventListener("click",()=>{const el=document.querySelector(".browser");el.classList.toggle("collapsed");toggleBrowser.textContent=el.classList.contains("collapsed")?"å±•å¼€":"æŠ˜å "})}
if(toggleConfig){toggleConfig.addEventListener("click",()=>{const el=document.querySelector(".config");el.classList.toggle("collapsed");toggleConfig.textContent=el.classList.contains("collapsed")?"å±•å¼€":"æŠ˜å "})}
